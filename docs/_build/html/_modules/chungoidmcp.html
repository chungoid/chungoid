

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chungoidmcp &mdash; Chungoid MCP Server 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Chungoid MCP Server
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Chungoid MCP Server</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">chungoidmcp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for chungoidmcp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Main MCP Server implementation for Chungoid Bootstrapper.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># --- Custom Exceptions ---</span>
<div class="viewcode-block" id="SecurityError">
<a class="viewcode-back" href="../index.html#chungoidmcp.SecurityError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SecurityError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom exception for security-related errors, like path traversal.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="c1"># --- MCP and Project Imports ---</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">Context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils.logger_setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils.state_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateManager</span><span class="p">,</span> <span class="n">StatusFileError</span> <span class="c1"># &lt;&lt;&lt; RESTORED &gt;&gt;&gt;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stage_executor</span><span class="w"> </span><span class="kn">import</span> <span class="n">StageExecutor</span><span class="p">,</span> <span class="n">StageExecutionError</span> <span class="c1"># &lt;&lt;&lt; Uncommented</span>

<span class="c1"># Load environment variables from .env file</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Define the env var name *before* using it</span>
<span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;CHUNGOID_PROJECT_DIR&quot;</span>

<span class="c1"># --- &lt;&lt;&lt; NEW: Read Project Directory from Environment Variable &gt;&gt;&gt; ---</span>
<span class="n">GLOBAL_PROJECT_DIR</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="p">)</span>
<span class="k">if</span> <span class="n">GLOBAL_PROJECT_DIR</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Resolve and validate the path immediately</span>
        <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">GLOBAL_PROJECT_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">GLOBAL_PROJECT_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolved_path</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using project directory from env var </span><span class="si">{</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">GLOBAL_PROJECT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path from env var </span><span class="si">{</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">GLOBAL_PROJECT_DIR</span><span class="si">}</span><span class="s2">&#39;) is not a valid directory. Path resolution: </span><span class="si">{</span><span class="n">resolved_path</span><span class="si">}</span><span class="s2">. Server may fail.&quot;</span><span class="p">)</span>
            <span class="n">GLOBAL_PROJECT_DIR</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Invalidate if not a dir</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resolving path from env var </span><span class="si">{</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">GLOBAL_PROJECT_DIR</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Server may fail.&quot;</span><span class="p">)</span>
        <span class="n">GLOBAL_PROJECT_DIR</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Invalidate on error</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment variable </span><span class="si">{</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="si">}</span><span class="s2"> is not set. Server cannot determine project directory and will likely fail.&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required environment variable </span><span class="si">{</span><span class="n">CHUNGOID_PROJECT_DIR_ENV_VAR</span><span class="si">}</span><span class="s2"> is not set.&quot;</span><span class="p">)</span>
<span class="c1"># --- &lt;&lt;&lt; END NEW &gt;&gt;&gt; ---</span>

<span class="c1"># Determine the base directory of the Chungoid MCP server installation FIRST</span>
<span class="c1"># This assumes chungoidmcp.py is at the root of the installation</span>
<span class="n">CHUNGOID_BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

<span class="c1"># Configure logging to use the base directory</span>
<span class="n">setup_logging</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Also set FastMCP&#39;s internal logger to DEBUG if possible (optional, setup_logging might cover it)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;FastMCP&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;mcp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not explicitly set FastMCP/MCP logger level.&quot;</span><span class="p">)</span>

<span class="c1"># --- Module-Level Initialization ---</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Chungoid MCP Server components at module level...&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chungoid base directory determined as: </span><span class="si">{</span><span class="n">CHUNGOID_BASE_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Initialize FastMCP instance with STDIO transport FIRST</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ChungoidMCP&quot;</span><span class="p">,</span> <span class="c1"># Restored name</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
        <span class="n">transport</span><span class="o">=</span><span class="s2">&quot;stdio&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># &lt;&lt;&lt; COMMENTED OUT Module-Level StateManager Initialization &gt;&gt;&gt;</span>
<span class="c1"># try:</span>
<span class="c1">#     # Determine the absolute path to the server stages directory</span>
<span class="c1">#     SERVER_STAGES_RELATIVE_PATH = &quot;server_prompts/stages&quot; # Standard location</span>
<span class="c1">#     server_stages_absolute_path = CHUNGOID_BASE_DIR / SERVER_STAGES_RELATIVE_PATH</span>
<span class="c1">#     logger.info(f&quot;Server stages directory determined as: {server_stages_absolute_path}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     # --- &lt;&lt;&lt; FIX: Construct absolute path for status file &gt;&gt;&gt; ---</span>
<span class="c1">#     if GLOBAL_PROJECT_DIR:</span>
<span class="c1">#         chungoid_dir = Path(GLOBAL_PROJECT_DIR) / &quot;.chungoid&quot;</span>
<span class="c1">#         status_file_absolute_path = chungoid_dir / &quot;project_status.json&quot;</span>
<span class="c1">#         logger.info(&quot;Derived absolute status file path: %s&quot;, status_file_absolute_path)</span>
<span class="c1">#     else:</span>
<span class="c1">#         # This path should not be reached anymore due to the raise above</span>
<span class="c1">#         logger.error(&quot;Critical Error: GLOBAL_PROJECT_DIR check failed unexpectedly after initial validation.&quot;)</span>
<span class="c1">#         raise ValueError(&quot;StateManager initialization failed: Project directory validation failed.&quot;)</span>
<span class="c1">#     # --- &lt;&lt;&lt; END FIX &gt;&gt;&gt; ---</span>
<span class="c1">#</span>
<span class="c1">#     # Initialize StateManager with the required arguments</span>
<span class="c1">#     state_manager = StateManager(</span>
<span class="c1">#         target_directory=str(CHUNGOID_BASE_DIR), # Pass the project root directory</span>
<span class="c1">#         server_stages_dir=str(server_stages_absolute_path)</span>
<span class="c1">#     )</span>
<span class="c1">#</span>
<span class="c1">#     # Pass necessary ABSOLUTE paths/configs to StageExecutor</span>
<span class="c1">#     # REMOVED module-level instance, as handlers now create context-specific ones.</span>
<span class="c1">#</span>
<span class="c1">#     # Removed instantiation of non-existent ApplicationSecurity</span>
<span class="c1">#</span>
<span class="c1">#     logger.info(&quot;Chungoid MCP Server components initialized successfully.&quot;)</span>
<span class="c1">#</span>
<span class="c1"># except FileNotFoundError as fnf_error:</span>
<span class="c1">#     logger.exception(&quot;Initialization failed: Required file not found: %s&quot;, fnf_error)</span>
<span class="c1">#     raise</span>
<span class="c1"># except Exception as e:</span>
<span class="c1">#     # Use % formatting for logging exceptions</span>
<span class="c1">#     logger.exception(&quot;Unexpected error during module-level initialization: %s&quot;, e)</span>
<span class="c1">#     raise</span>
<span class="c1"># &lt;&lt;&lt; End COMMENTED OUT Initialization Block &gt;&gt;&gt;</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FastMCP instance created. StateManager initialization deferred to tool calls.&quot;</span><span class="p">)</span>


<span class="c1"># --- ASGI Application Entry Point ---</span>
<span class="c1"># No ASGI app needed for stdio transport.</span>

<span class="c1"># --- Session Management (Simple Global Dictionary) ---</span>
<span class="n">client_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">stdio_client_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># --- Helper function to get target directory ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_target_directory</span><span class="p">(</span>
    <span class="n">target_directory_arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the effective target directory, prioritizing:</span>
<span class="sd">    1. Explicit argument (if provided)</span>
<span class="sd">    2. Session context (if ctx or stdio_client_id exists)</span>
<span class="sd">    3. Global environment variable fallback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Prioritize the explicit argument if it&#39;s valid</span>
    <span class="k">if</span> <span class="n">target_directory_arg</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explicit target_directory argument provided: </span><span class="si">{</span><span class="n">target_directory_arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_directory_arg</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using valid directory provided via argument: </span><span class="si">{</span><span class="n">resolved_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolved_path</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Return the validated explicit path</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># If explicit argument is invalid, log error but continue to check session/global</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Provided target_directory argument &#39;</span><span class="si">{</span><span class="n">target_directory_arg</span><span class="si">}</span><span class="s2">&#39; resolves to &#39;</span><span class="si">{</span><span class="n">resolved_path</span><span class="si">}</span><span class="s2">&#39; which is not a directory. Checking session/global...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="c1"># If resolving fails, log error but continue to check session/global</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resolving provided target_directory argument &#39;</span><span class="si">{</span><span class="n">target_directory_arg</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Checking session/global...&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Check Session Context (only if explicit argument was NOT provided or was invalid)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking session context for target directory.&quot;</span><span class="p">)</span>
    <span class="n">session_target_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">effective_client_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Determine the effective client ID (handle stdio case)</span>
    <span class="n">original_client_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">client_id</span> <span class="k">if</span> <span class="n">ctx</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_client_id</span><span class="p">:</span>
        <span class="c1"># Likely stdio transport, use the stored stdio_client_id</span>
        <span class="k">if</span> <span class="n">stdio_client_id</span><span class="p">:</span>
            <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">stdio_client_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using stored stdio_client_id for session lookup: </span><span class="si">{</span><span class="n">stdio_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No original client_id and no stored stdio_client_id, cannot check session.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">original_client_id</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using original client_id for session lookup: </span><span class="si">{</span><span class="n">original_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Look up the directory in the session if we have an ID</span>
    <span class="k">if</span> <span class="n">effective_client_id</span> <span class="ow">and</span> <span class="n">effective_client_id</span> <span class="ow">in</span> <span class="n">client_sessions</span><span class="p">:</span>
        <span class="n">session_target_dir</span> <span class="o">=</span> <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_directory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">session_target_dir</span><span class="p">:</span>
             <span class="c1"># Validate the path stored in the session</span>
             <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">session_target_dir</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using project directory from session context for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">session_target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="n">session_target_dir</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path from session context for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">session_target_dir</span><span class="si">}</span><span class="s2">&#39;) is not a valid directory. Ignoring.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;target_directory&#39; found in session context for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_client_id</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No session found in client_sessions for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># End Session Check</span>

    <span class="c1"># 3. Fallback to the global environment variable if no valid argument or session context found</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking environment variable fallback for target directory.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">GLOBAL_PROJECT_DIR</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using project directory from environment variable fallback: </span><span class="si">{</span><span class="n">GLOBAL_PROJECT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GLOBAL_PROJECT_DIR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 4. Error if neither argument, session, nor env var yields a valid directory</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not determine project directory from argument, session, or environment variable. Check setup.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># --- Helper function to initialize StateManager within a tool call --- &lt;&lt;&lt; UNCOMMENTED &gt;&gt;&gt;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">target_dir_path_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes StateManager for a given target directory path. Raises exceptions on failure.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to initialize StateManager for target: </span><span class="si">{</span><span class="n">target_dir_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">target_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_dir_path_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory &#39;</span><span class="si">{</span><span class="n">target_dir_path_str</span><span class="si">}</span><span class="s2">&#39; is not a valid directory.&quot;</span><span class="p">)</span>

        <span class="c1"># Define paths needed for StateManager initialization</span>
        <span class="n">SERVER_STAGES_RELATIVE_PATH</span> <span class="o">=</span> <span class="s2">&quot;server_prompts/stages&quot;</span> <span class="c1"># Standard location</span>
        <span class="n">server_stages_absolute_path</span> <span class="o">=</span> <span class="n">CHUNGOID_BASE_DIR</span> <span class="o">/</span> <span class="n">SERVER_STAGES_RELATIVE_PATH</span>

        <span class="c1"># Initialize StateManager</span>
        <span class="n">state_manager_instance</span> <span class="o">=</span> <span class="n">StateManager</span><span class="p">(</span>
            <span class="n">target_directory</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">target_dir_path</span><span class="p">),</span> <span class="c1"># Use the provided target path</span>
            <span class="n">server_stages_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">server_stages_absolute_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialized successfully for target: </span><span class="si">{</span><span class="n">target_dir_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_manager_instance</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize StateManager for target &#39;</span><span class="si">{</span><span class="n">target_dir_path_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="c1"># Re-raise the exception to be caught by the calling tool handler</span>


<span class="c1"># --- MCP Tool Handlers (Top-Level Async Functions) ---</span>
<span class="c1"># &lt;&lt;&lt; Restore original handlers with deferred StateManager init &gt;&gt;&gt;</span>
<div class="viewcode-block" id="set_project_context">
<a class="viewcode-back" href="../index.html#chungoidmcp.set_project_context">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;set_project_context&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sets the target project directory for the current client session, removing the need to specify it in subsequent calls.&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_project_context</span><span class="p">(</span><span class="n">target_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets the target_directory in the server&#39;s session state for the calling client.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">stdio_client_id</span> <span class="c1"># &lt;&lt;&lt; Declare global to modify it</span>
    <span class="n">original_client_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">client_id</span> <span class="c1"># &lt;&lt;&lt; Use original_client_id</span>
    <span class="n">effective_client_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># &lt;&lt;&lt; Define effective_client_id</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_project_context called for original_client_id: </span><span class="si">{</span><span class="n">original_client_id</span><span class="si">}</span><span class="s2">, target_directory: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_client_id</span><span class="p">:</span>
        <span class="c1"># Client ID missing from context (likely stdio transport)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original client_id missing from context. Handling as potential stdio session.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdio_client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Generate and store a persistent ID for this stdio server instance</span>
            <span class="n">stdio_client_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated and stored new stdio_client_id: </span><span class="si">{</span><span class="n">stdio_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using existing stdio_client_id: </span><span class="si">{</span><span class="n">stdio_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">stdio_client_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Client ID provided by context (e.g., websocket transport)</span>
        <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">original_client_id</span>

    <span class="c1"># Now, proceed using the effective_client_id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_client_id</span><span class="p">:</span>
        <span class="c1"># This case should theoretically not happen if logic above is correct</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Critical error: Effective client ID is still missing after handling.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal server error: Could not determine client identifier.&quot;</span><span class="p">}</span>

    <span class="c1"># Basic validation of the directory path (check if it&#39;s a non-empty string)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_directory</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_directory</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid target_directory provided for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid &#39;target_directory&#39; provided. It must be a non-empty string.&quot;</span><span class="p">}</span>

    <span class="c1"># Simple path check (does not guarantee it&#39;s a valid *project* dir)</span>
    <span class="c1"># More robust checks could be added if needed (e.g., check for .chungoid)</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39; provided for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2"> does not exist or is not a directory.&quot;</span><span class="p">)</span>
         <span class="c1"># Allow setting anyway, but log a warning. Initialization/other tools will fail later if invalid.</span>

    <span class="k">if</span> <span class="n">effective_client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">client_sessions</span><span class="p">:</span> <span class="c1"># &lt;&lt;&lt; Use effective_client_id</span>
        <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># &lt;&lt;&lt; Use effective_client_id</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized new session for client_id: </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Use effective_client_id</span>

    <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">][</span><span class="s1">&#39;target_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span> <span class="c1"># Store resolved absolute path # &lt;&lt;&lt; Use effective_client_id</span>
    <span class="n">stored_path</span> <span class="o">=</span> <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">][</span><span class="s1">&#39;target_directory&#39;</span><span class="p">]</span> <span class="c1"># &lt;&lt;&lt; Use effective_client_id</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set target_directory for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2"> to: </span><span class="si">{</span><span class="n">stored_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Use effective_client_id</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Project context set to </span><span class="si">{</span><span class="n">stored_path</span><span class="si">}</span><span class="s2"> for this session.&quot;</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="handle_initialize_project">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_initialize_project">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;initialize_project&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Copies necessary template files and directories into the REQUIRED target directory to set up a new project for Chungoid.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_initialize_project</span><span class="p">(</span><span class="n">target_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;initialize_project&#39; tool. Copies templates to the specified directory.</span>

<span class="sd">    On success, also sets the target directory context for the current session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;handle_initialize_project called. Target_directory: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># --- Validation (Simpler: Only check if it&#39;s a non-empty string) ---</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_directory</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_directory</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing or invalid &#39;target_directory&#39; argument.&quot;</span><span class="p">)</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
             <span class="s2">&quot;Error: Missing or invalid &#39;target_directory&#39; argument. &quot;</span>
             <span class="s2">&quot;ACTION REQUIRED: Agent must determine the current working directory (CWD) by running `pwd`. &quot;</span>
             <span class="s2">&quot;Then, recall this tool (&#39;initialize_project&#39;) with the CWD path provided as the &#39;target_directory&#39; argument. &quot;</span>
             <span class="s2">&quot;Example: `@chungoid initialize_project target_directory=</span><span class="se">\&quot;</span><span class="s2">/path/from/pwd</span><span class="se">\&quot;</span><span class="s2">`&quot;</span> <span class="c1"># Simplified example</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">error_message</span>
        <span class="p">}</span>
    <span class="c1"># --- End Validation ---</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proceeding with initialization in target_directory: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the provided target_directory argument directly</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved target directory: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure target directory exists or create it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
             <span class="k">if</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory path exists but is a file: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Target directory path exists but is a file: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory does not exist, creating: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">try</span><span class="p">:</span>
                     <span class="n">target_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create target directory </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to create target directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="c1"># Define source paths relative to the Chungoid installation base</span>
        <span class="n">source_server_prompts_dir</span> <span class="o">=</span> <span class="n">CHUNGOID_BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;server_prompts&quot;</span>
        <span class="c1"># source_templates_dir = CHUNGOID_BASE_DIR / &quot;templates&quot; # REMOVED</span>

        <span class="c1"># Define specific source files</span>
        <span class="c1"># source_build_prompt = source_templates_dir / &quot;build-prompt.txt&quot; # REMOVED</span>
        <span class="n">source_initial_status</span> <span class="o">=</span> <span class="n">source_server_prompts_dir</span> <span class="o">/</span> <span class="s2">&quot;initial_status.json&quot;</span>
        <span class="c1"># source_goal_template = source_templates_dir / &quot;drop-in-goal.txt&quot; # No longer copied</span>

        <span class="c1"># Define destination paths in the target directory (using the argument)</span>
        <span class="n">dest_chungoid_dir</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s2">&quot;.chungoid&quot;</span>
        <span class="c1"># dest_build_prompt = dest_chungoid_dir / &quot;build-prompt.txt&quot; # REMOVED</span>
        <span class="n">dest_status_file</span> <span class="o">=</span> <span class="n">dest_chungoid_dir</span> <span class="o">/</span> <span class="s2">&quot;project_status.json&quot;</span>
        <span class="c1"># dest_goal_file = target_dir / &quot;goal.txt&quot; # No longer created here</span>
        <span class="c1"># dest_stages_dir = dest_chungoid_dir / &quot;templates&quot; / &quot;stages&quot; # REMOVED destination mapping</span>
        <span class="c1"># Destination for the auto-start rule - REMOVED</span>
        <span class="c1"># dest_rules_dir = target_dir / &quot;.cursor&quot; / &quot;rules&quot; / &quot;global-rules&quot;</span>
        <span class="c1"># dest_auto_start_rule = dest_rules_dir / &quot;chungoid_auto_start_stage0.mdc&quot;</span>

        <span class="c1"># Define source for the auto-start rule - REMOVED</span>
        <span class="c1"># source_rules_template_dir = CHUNGOID_BASE_DIR / &quot;templates&quot; / &quot;rules&quot;</span>
        <span class="c1"># source_auto_start_rule = source_rules_template_dir / &quot;auto_start_stage0.mdc&quot;</span>

        <span class="c1"># Overwrite is no longer an option via kwargs</span>
        <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Default to False, or decide a fixed behavior</span>

        <span class="n">copied_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensuring target directory structure exists...&quot;</span><span class="p">)</span>
        <span class="c1"># Ensure the main .chungoid directory and stages dir exist</span>
        <span class="c1"># dest_stages_dir.mkdir(parents=True, exist_ok=True) # REMOVED creation of old stages dir</span>
        <span class="n">dest_chungoid_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Ensure .chungoid still gets created</span>
        <span class="c1"># dest_rules_dir.mkdir(parents=True, exist_ok=True) # REMOVED rules dir creation</span>

        <span class="c1"># --- Copy individual files ---</span>
        <span class="n">files_to_copy</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># (source_build_prompt, dest_build_prompt), # REMOVED</span>
            <span class="p">(</span><span class="n">source_initial_status</span><span class="p">,</span> <span class="n">dest_status_file</span><span class="p">),</span>
            <span class="c1"># (source_auto_start_rule, dest_auto_start_rule), # REMOVED rule file copy</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Source file missing: </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span> <span class="c1"># Skip this file</span>

            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Skipping copy: Destination file </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2"> already exists and overwrite is False.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">skipped_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
                <span class="k">continue</span> <span class="c1"># Skip copying if destination exists and overwrite is false</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="c1"># copy2 preserves metadata</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">copied_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">copy_err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error copying </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">copy_err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># --- Copy stages directory --- # REMOVED ENTIRE BLOCK</span>

        <span class="c1"># --- Construct response ---</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Project initialization encountered errors.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;copied&quot;</span><span class="p">:</span> <span class="n">copied_items</span><span class="p">,</span>
                <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped_items</span><span class="p">,</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">skipped_items</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">copied_items</span><span class="p">:</span>
             <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Project initialization skipped. All target files/dirs already exist.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped_items</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># &lt;&lt;&lt; SUCCESS: Also set session context &gt;&gt;&gt;</span>
            <span class="n">success_message</span> <span class="o">=</span> <span class="s2">&quot;Project initialized successfully.&quot;</span>
            <span class="n">context_set_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span> <span class="c1"># Only try to set context if ctx is available</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Resolve path once more just to be safe</span>
                    <span class="n">resolved_target_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

                    <span class="c1"># --- Replicate logic from set_project_context --- #</span>
                    <span class="k">global</span> <span class="n">stdio_client_id</span>
                    <span class="n">original_client_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">client_id</span>
                    <span class="n">effective_client_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_client_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">stdio_client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">stdio_client_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                        <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">stdio_client_id</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">effective_client_id</span> <span class="o">=</span> <span class="n">original_client_id</span>

                    <span class="k">if</span> <span class="n">effective_client_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">effective_client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">client_sessions</span><span class="p">:</span>
                            <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">client_sessions</span><span class="p">[</span><span class="n">effective_client_id</span><span class="p">][</span><span class="s1">&#39;target_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_target_dir</span>
                        <span class="n">context_set_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Session context automatically set to </span><span class="si">{</span><span class="n">resolved_target_dir</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically set session context for client </span><span class="si">{</span><span class="n">effective_client_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">resolved_target_dir</span><span class="si">}</span><span class="s2"> after successful initialization.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine effective client ID during initialization context setting.&quot;</span><span class="p">)</span>
                        <span class="n">context_set_message</span> <span class="o">=</span> <span class="s2">&quot; Could not automatically set session context (client ID missing).&quot;</span>
                    <span class="c1"># --- End replicated logic --- #</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">context_err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error automatically setting session context after initialization: </span><span class="si">{</span><span class="n">context_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">context_set_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Project initialized, but failed to automatically set session context: </span><span class="si">{</span><span class="n">context_err</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">success_message</span> <span class="o">+</span> <span class="n">context_set_message</span><span class="p">,</span>
                <span class="s2">&quot;copied&quot;</span><span class="p">:</span> <span class="n">copied_items</span><span class="p">,</span>
                <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped_items</span><span class="p">,</span>
                <span class="s2">&quot;next_action_hint&quot;</span><span class="p">:</span> <span class="s2">&quot;execute_next_stage&quot;</span> <span class="c1"># &lt;&lt;&lt; Update hint</span>
            <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch unexpected errors during path resolution or copying</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during project initialization for target &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>



<div class="viewcode-block" id="handle_get_initialization_context">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_get_initialization_context">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_initialization_context&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides instructions and a template for calling &#39;initialize_project&#39; when the target directory needs to be the current working directory.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_get_initialization_context</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;get_initialization_context&#39; tool. Guides the agent to determine CWD and call initialize_project.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received &#39;get_initialization_context&#39; request.&quot;</span><span class="p">)</span>

    <span class="c1"># Construct response with the extremely simplified template</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTION_REQUIRED&quot;</span><span class="p">,</span>
        <span class="s2">&quot;agent_instruction&quot;</span><span class="p">:</span> <span class="s2">&quot;Run `pwd` to get your current working directory (CWD).&quot;</span><span class="p">,</span>
        <span class="s2">&quot;next_tool_call_template&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="s2">&quot;initialize_project&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="c1"># Only target_directory now</span>
                 <span class="s2">&quot;target_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;REPLACE_WITH_CWD_OUTPUT&gt;&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;next_step_description&quot;</span><span class="p">:</span> <span class="p">(</span>
             <span class="s2">&quot;After running `pwd`, call the &#39;initialize_project&#39; tool using the arguments template above, replacing &#39;&lt;REPLACE_WITH_CWD_OUTPUT&gt;&#39; with the actual path returned by `pwd`.&quot;</span> <span class="c1"># Simplified description</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">response</span></div>



<div class="viewcode-block" id="handle_execute_next_stage">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_execute_next_stage">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;execute_next_stage&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Executes the next pending stage. Uses environment variable for project dir if target_directory not provided.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_execute_next_stage</span><span class="p">(</span><span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;execute_next_stage&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;execute_next_stage&#39; request (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
    <span class="c1"># Pass target_directory_arg explicitly now</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory_arg</span><span class="o">=</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory. Ensure client is configured with CHUNGOID_PROJECT_DIR or set session context.&quot;</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing next stage for effective target: &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># &lt;&lt;&lt; Initialize StateManager within the handler &gt;&gt;&gt;</span>
        <span class="n">context_state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

        <span class="c1"># --- Get Next Stage --- #</span>
        <span class="n">next_stage_num</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">get_next_stage</span><span class="p">()</span>
        <span class="n">last_status</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">get_last_status</span><span class="p">()</span> <span class="c1"># Get last status for context</span>
        <span class="n">previous_stage_num</span> <span class="o">=</span> <span class="n">last_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">last_status</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># --- Prepare arguments for StageExecutor --- #</span>
        <span class="n">decision_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># &lt;&lt;&lt; REMOVE context retrieval/formatting block &gt;&gt;&gt;</span>
        <span class="c1"># reflections_context_str = ...</span>
        <span class="c1"># artifacts_context_str = ...</span>
        <span class="c1"># try...except block for context retrieval... REMOVE</span>
        <span class="c1"># &lt;&lt;&lt; END REMOVE &gt;&gt;&gt;</span>

        <span class="c1"># &lt;&lt;&lt; Calculate server prompt paths &gt;&gt;&gt;</span>
        <span class="n">script_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">server_stages_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">script_dir</span> <span class="o">/</span> <span class="s2">&quot;server_prompts&quot;</span> <span class="o">/</span> <span class="s2">&quot;stages&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
        <span class="n">common_template_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">script_dir</span> <span class="o">/</span> <span class="s2">&quot;server_prompts&quot;</span> <span class="o">/</span> <span class="s2">&quot;common_template.yaml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated server_stages_dir: </span><span class="si">{</span><span class="n">server_stages_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated common_template_path: </span><span class="si">{</span><span class="n">common_template_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Stage Loading &amp; Execution --- #</span>
        <span class="n">stage_executor</span> <span class="o">=</span> <span class="n">StageExecutor</span><span class="p">(</span>
            <span class="n">state_manager</span><span class="o">=</span><span class="n">context_state_manager</span><span class="p">,</span>
            <span class="n">decision_logic_config</span><span class="o">=</span><span class="n">decision_config</span><span class="p">,</span>
            <span class="n">project_root_dir</span><span class="o">=</span><span class="n">effective_target_directory</span><span class="p">,</span>
            <span class="n">reflections_summary</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt; Pass empty string for now</span>
            <span class="n">server_stages_dir</span><span class="o">=</span><span class="n">server_stages_dir</span><span class="p">,</span>
            <span class="n">common_template_path</span><span class="o">=</span><span class="n">common_template_path</span>
        <span class="p">)</span>

        <span class="c1"># Pass EMPTY context_data to the prompt rendering initially.</span>
        <span class="c1"># Agent is now responsible for using tools to get context.</span>
        <span class="n">prompt_content</span> <span class="o">=</span> <span class="n">stage_executor</span><span class="o">.</span><span class="n">prompt_manager</span><span class="o">.</span><span class="n">get_rendered_prompt</span><span class="p">(</span>
            <span class="n">stage_number</span><span class="o">=</span><span class="n">next_stage_num</span><span class="p">,</span>
            <span class="n">context_data</span><span class="o">=</span><span class="p">{}</span> <span class="c1"># &lt;&lt;&lt; Pass empty dictionary</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returning prompt for stage </span><span class="si">{</span><span class="n">next_stage_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;next_stage&quot;</span><span class="p">:</span> <span class="n">next_stage_num</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt_content</span><span class="p">}</span>

    <span class="c1"># &lt;&lt;&lt; Catch StateManager init errors specifically &gt;&gt;&gt;</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state for next stage: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">. Project might be uninitialized. Try running &#39;initialize_project&#39; first.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed for next stage execution in &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">err_msg</span><span class="p">}</span>
    <span class="k">except</span> <span class="n">StageExecutionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage execution error in &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="c1"># Catch specific errors from StateManager like cannot determine next stage</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime error during next stage execution in &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during next stage execution in &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected server error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_get_project_status">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_get_project_status">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_project_status&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Retrieves project status. Uses environment variable for project dir if target_directory not provided.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_get_project_status</span><span class="p">(</span><span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;get_project_status&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;get_project_status&#39; request (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;) with args: </span><span class="si">{</span><span class="n">ctx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory. Provide valid &#39;target_directory&#39; argument or set CHUNGOID_PROJECT_DIR env var and restart server.&quot;</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting project status for effective target: &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># &lt;&lt;&lt; Wrap main logic in try...finally &gt;&gt;&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># &lt;&lt;&lt; Initialize StateManager within the handler &gt;&gt;&gt;</span>
            <span class="n">context_state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

            <span class="n">target_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>
            <span class="c1"># project_status_file check removed, handled by StateManager init</span>

            <span class="n">project_initialized</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Assume initialized if StateManager loaded</span>
            <span class="n">last_stage_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;artifacts&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">full_status_data</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">full_status_data</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">get_full_status</span><span class="p">()</span>
                <span class="n">last_status</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">get_last_status</span><span class="p">()</span>

                <span class="c1"># &lt;&lt;&lt; RESTORE last_status calculation &gt;&gt;&gt;</span>
                <span class="k">if</span> <span class="n">last_status</span><span class="p">:</span>
                    <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span>
                    <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
                    <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;artifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifacts&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                     <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PENDING&quot;</span>
                     <span class="n">last_stage_info</span><span class="p">[</span><span class="s2">&quot;artifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="n">StatusFileError</span> <span class="k">as</span> <span class="n">sfe</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading status file via StateManager for target </span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sfe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="c1"># If StateManager init succeeded but reading status failed later</span>
                 <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to read project status file: </span><span class="si">{</span><span class="n">sfe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

            <span class="c1"># &lt;&lt;&lt; UNCOMMENTING the session logic block &gt;&gt;&gt;</span>
            <span class="c1"># Attempt to get context-specific data if ctx is available</span>
            <span class="n">client_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">client_id</span> <span class="k">if</span> <span class="n">ctx</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># Safely access client_id</span>
            <span class="n">session_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># &lt;&lt;&lt; Simplified session access for stdio &gt;&gt;&gt;</span>
            <span class="c1"># &lt;&lt;&lt; ADD DEBUG LOGS &gt;&gt;&gt;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking session data: stdio_client_id=&#39;</span><span class="si">{</span><span class="n">stdio_client_id</span><span class="si">}</span><span class="s2">&#39;, client_id=&#39;</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">&#39;, client_sessions keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">client_sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stdio_client_id</span> <span class="ow">and</span> <span class="n">stdio_client_id</span> <span class="ow">in</span> <span class="n">client_sessions</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to get session data using stdio_client_id: </span><span class="si">{</span><span class="n">stdio_client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="n">session_data</span> <span class="o">=</span> <span class="n">client_sessions</span><span class="p">[</span><span class="n">stdio_client_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_directory&#39;</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Assigns to session_data</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got session_data: </span><span class="si">{</span><span class="n">session_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">client_id</span> <span class="ow">and</span> <span class="n">client_id</span> <span class="ow">in</span> <span class="n">client_sessions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to get session data using client_id: </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">session_data</span> <span class="o">=</span> <span class="n">client_sessions</span><span class="p">[</span><span class="n">client_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_directory&#39;</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Assigns to session_data</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got session_data: </span><span class="si">{</span><span class="n">session_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No matching client ID found in sessions to retrieve session_data.&quot;</span><span class="p">)</span>
            <span class="c1"># &lt;&lt;&lt; END ADD DEBUG LOGS &gt;&gt;&gt;</span>

            <span class="c1"># &lt;&lt;&lt; Partially restore summary dictionary &gt;&gt;&gt;</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Status retrieved successfully.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target_directory&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_dir_path</span><span class="p">),</span>
                <span class="s2">&quot;project_initialized&quot;</span><span class="p">:</span> <span class="n">project_initialized</span><span class="p">,</span>
                <span class="s2">&quot;last_status&quot;</span><span class="p">:</span> <span class="n">last_stage_info</span><span class="p">,</span>
                <span class="s2">&quot;full_history&quot;</span><span class="p">:</span> <span class="n">full_status_data</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt; UNCOMMENTED &gt;&gt;&gt;</span>
                <span class="s2">&quot;session_context&quot;</span><span class="p">:</span> <span class="n">session_data</span> <span class="c1"># Include session context if available # &lt;&lt;&lt; UNCOMMENTED &gt;&gt;&gt;</span>
            <span class="p">}</span>

            <span class="c1"># &lt;&lt;&lt; Return the partially restored summary &gt;&gt;&gt;</span>
            <span class="c1"># NOTE: The final logger.info call is moved to the finally block</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">}</span>

        <span class="c1"># &lt;&lt;&lt; Catch StateManager init errors specifically &gt;&gt;&gt;</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed retrieving status for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">. Assuming project is uninitialized.&quot;</span><span class="p">)</span>
            <span class="c1"># Project likely uninitialized if StateManager fails here</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="c1"># Return success, but indicate not initialized</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Project status checked. Project appears uninitialized.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;target_directory&quot;</span><span class="p">:</span> <span class="n">effective_target_directory</span><span class="p">,</span>
                    <span class="s2">&quot;project_initialized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;last_status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;UNINITIALIZED&quot;</span><span class="p">,</span> <span class="s2">&quot;artifacts&quot;</span><span class="p">:</span> <span class="p">[]},</span>
                    <span class="s2">&quot;full_history&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;session_context&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;error_note&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Could not read status file: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;next_action_hint&quot;</span><span class="p">:</span> <span class="s2">&quot;initialize_project&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error retrieving project status for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">error_client_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">client_id</span> <span class="k">if</span> <span class="n">ctx</span> <span class="k">else</span> <span class="n">stdio_client_id</span> <span class="k">if</span> <span class="n">stdio_client_id</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to retrieve project status due to unexpected server error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (Client: </span><span class="si">{</span><span class="n">error_client_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># &lt;&lt;&lt; This log should now ALWAYS execute before the function truly exits &gt;&gt;&gt;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting handle_get_project_status for target </span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_submit_stage_artifacts">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_submit_stage_artifacts">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;submit_stage_artifacts&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Submits artifacts. Uses environment variable for project dir if target_directory not provided.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_submit_stage_artifacts</span><span class="p">(</span>
    <span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stage_number</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">generated_artifacts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">stage_result_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;submit_stage_artifacts&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;submit_stage_artifacts&#39; (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;) for stage=&#39;</span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">&#39;, status=&#39;</span><span class="si">{</span><span class="n">stage_result_status</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory. Provide valid &#39;target_directory&#39; argument or set CHUNGOID_PROJECT_DIR env var and restart server.&quot;</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Submitting artifacts for effective target: &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;, stage: </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">target_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

    <span class="c1"># --- Input Validation --- #</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_number</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="n">stage_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid stage_number. Must be a non-negative number.&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generated_artifacts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid generated_artifacts. Must be a dictionary.&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Target directory not found or invalid: </span><span class="si">{</span><span class="n">target_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">valid_statuses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DONE&quot;</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">,</span> <span class="s2">&quot;PASS&quot;</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stage_result_status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_statuses</span><span class="p">:</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid stage_result_status &#39;</span><span class="si">{</span><span class="n">stage_result_status</span><span class="si">}</span><span class="s2">&#39;. Use </span><span class="si">{</span><span class="n">valid_statuses</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
    <span class="n">final_status</span> <span class="o">=</span> <span class="n">stage_result_status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="c1"># --- End Input Validation --- #</span>

    <span class="c1"># --- Determine Artifacts to Process --- #</span>
    <span class="n">artifacts_to_process</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">generated_artifacts</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing artifacts explicitly provided in the tool call.&quot;</span><span class="p">)</span>
        <span class="c1"># Validate provided content is string</span>
        <span class="n">valid_provided</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">generated_artifacts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid content type for provided artifact &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;. Expected string, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping artifact writing.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid content type for provided artifact &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">}</span>
        <span class="n">artifacts_to_process</span> <span class="o">=</span> <span class="n">generated_artifacts</span> <span class="c1"># Use provided dict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Infer artifacts from expected stage output (simple hardcoded example for Stage 0 for now)</span>
        <span class="c1"># TODO: Load this dynamically from stage prompt yaml or previous status</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No artifacts provided in tool call. Inferring artifacts based on hardcoded Stage 0 expectation.&quot;</span><span class="p">)</span>
        <span class="n">expected_artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">stage_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">expected_artifacts</span> <span class="o">=</span> <span class="p">[</span>
                 <span class="s2">&quot;dev-docs/design/requirements.md&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;dev-docs/design/research_notes.md&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;dev-docs/design/blueprint.md&quot;</span>
             <span class="p">]</span>
        <span class="k">elif</span> <span class="n">stage_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">expected_artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dev-docs/design/validation_report.json&quot;</span><span class="p">]</span>
        <span class="c1"># Add other stages as needed</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No hardcoded expected artifacts found for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">. Will only update status.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expected_artifacts</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred artifacts for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">expected_artifacts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">expected_artifacts</span><span class="p">:</span>
                <span class="n">artifacts_to_process</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Mark for reading, content is None initially</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No artifacts inferred for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">. Only status will be updated.&quot;</span><span class="p">)</span>
    <span class="c1"># --- End Determine Artifacts --- #</span>

    <span class="n">written_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># --- Artifact Handling Loop --- #</span>
    <span class="k">for</span> <span class="n">rel_path_str</span><span class="p">,</span> <span class="n">content_or_none</span> <span class="ow">in</span> <span class="n">artifacts_to_process</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rel_path_str</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid artifact path key (must be non-empty string): </span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span> <span class="ow">or</span> <span class="n">rel_path_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Security risk: Invalid relative path &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span>
            <span class="n">abs_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dir_path</span> <span class="o">/</span> <span class="n">rel_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="c1"># Security Check: Ensure path is within target_dir_path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="n">target_dir_path</span><span class="p">):</span>
                 <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Security risk: Resolved path &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39; is outside target directory &#39;</span><span class="si">{</span><span class="n">target_dir_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                 <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                 <span class="k">continue</span>

            <span class="k">if</span> <span class="n">content_or_none</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="c1"># Content was provided explicitly, write it</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content_or_none</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                     <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid explicit content for &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; (must be string). Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content_or_none</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                     <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                     <span class="k">continue</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing explicitly provided artifact content to: </span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="n">abs_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="n">abs_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content_or_none</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                 <span class="n">written_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span> <span class="c1"># Mark as written</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># Content not provided, assume file exists (was generated by agent)</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Artifact &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; was inferred. Assuming it exists on disk.&quot;</span><span class="p">)</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                     <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Inferred artifact file not found: </span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&quot;</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                     <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="c1"># Report error if inferred file doesn&#39;t exist</span>
                     <span class="k">continue</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="c1"># File exists, mark it as &#39;written&#39; (or processed) for status update/ChromaDB</span>
                     <span class="n">written_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OS Error handling artifact &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; at &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error handling artifact &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; at &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="c1"># --- End Artifact Handling Loop --- #</span>

    <span class="n">status_updated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">status_update_error</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- Status Update (includes ChromaDB persistence) --- #</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># &lt;&lt;&lt; Initialize StateManager within the handler &gt;&gt;&gt;</span>
            <span class="n">context_state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

            <span class="c1"># Store reflections if provided</span>
            <span class="n">reflection_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s1">&#39;reflection_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">ctx</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reflection_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Storing reflection data for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                 <span class="n">reflection_stored</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">store_reflection</span><span class="p">(</span><span class="n">reflection_data</span><span class="p">)</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">reflection_stored</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to store reflection data.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">reflection_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Log if present but not a dict</span>
                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received reflection_data but it was not a dictionary (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">reflection_data</span><span class="p">)</span><span class="si">}</span><span class="s2">). Skipping storage.&quot;</span><span class="p">)</span>

            <span class="c1"># &lt;&lt;&lt; NEW: Store written artifacts in ChromaDB &gt;&gt;&gt;</span>
            <span class="k">if</span> <span class="n">written_files</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to store </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">written_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> written artifacts in ChromaDB...&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">rel_path_str</span> <span class="ow">in</span> <span class="n">written_files</span><span class="p">:</span>
                     <span class="k">try</span><span class="p">:</span>
                         <span class="c1"># Read the content back from the file that was just written</span>
                         <span class="n">abs_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dir_path</span> <span class="o">/</span> <span class="n">rel_path_str</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                         <span class="n">content</span> <span class="o">=</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                         <span class="c1"># Determine artifact type (simple heuristic based on path for now)</span>
                         <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
                         <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.java&#39;</span><span class="p">,</span> <span class="s1">&#39;.c&#39;</span><span class="p">,</span> <span class="s1">&#39;.cpp&#39;</span><span class="p">,</span> <span class="s1">&#39;.go&#39;</span><span class="p">]:</span>
                             <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>
                         <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.rst&#39;</span><span class="p">]:</span>
                             <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;document&quot;</span>
                         <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path_str</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">]:</span>
                             <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span>
                         <span class="c1"># Add more specific types based on path (e.g., dev-docs/design -&gt; design)</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/design&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;design&quot;</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/planning&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;planning&quot;</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/reports&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;report&quot;</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/validation&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/release&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;release&quot;</span>
                         <span class="k">if</span> <span class="s2">&quot;dev-docs/reflections&quot;</span> <span class="ow">in</span> <span class="n">rel_path_str</span><span class="p">:</span> <span class="n">artifact_type_guess</span> <span class="o">=</span> <span class="s2">&quot;reflection_doc&quot;</span> <span class="c1"># Separate from structured reflection</span>

                         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Storing artifact &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">artifact_type_guess</span><span class="si">}</span><span class="s2">) in ChromaDB for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                         <span class="c1"># Call StateManager to store</span>
                         <span class="n">stored_ok</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">store_artifact_context_in_chroma</span><span class="p">(</span>
                             <span class="n">rel_path</span><span class="o">=</span><span class="n">rel_path_str</span><span class="p">,</span>
                             <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                             <span class="n">stage_number</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">stage_number</span><span class="p">),</span>
                             <span class="n">artifact_type</span><span class="o">=</span><span class="n">artifact_type_guess</span>
                         <span class="p">)</span>
                         <span class="c1"># &lt;&lt;&lt; ADDED CHECK &gt;&gt;&gt;</span>
                         <span class="k">if</span> <span class="ow">not</span> <span class="n">stored_ok</span><span class="p">:</span>
                              <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager reported failure storing artifact context for </span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">. Check StateManager logs.&quot;</span><span class="p">)</span>
                              <span class="c1"># Optionally add to errors list if this should halt the overall submission:</span>
                              <span class="c1"># errors.append(f&quot;Failed to store {rel_path_str} context in ChromaDB.&quot;)</span>
                         <span class="c1"># &lt;&lt;&lt; END ADDED CHECK &gt;&gt;&gt;</span>
                     <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ChromaDB Store Error: File &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; not found after writing, cannot store context.&quot;</span><span class="p">)</span>
                          <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found for ChromaDB storage: </span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Add to errors</span>
                     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">chroma_err</span><span class="p">:</span>
                          <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ChromaDB Store Error: Failed to store artifact &#39;</span><span class="si">{</span><span class="n">rel_path_str</span><span class="si">}</span><span class="s2">&#39; context: </span><span class="si">{</span><span class="n">chroma_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                          <span class="c1"># Decide if this should prevent status update</span>

            <span class="c1"># Update the main status file</span>
            <span class="n">status_updated</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span>
                <span class="n">stage</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">stage_number</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="n">final_status</span><span class="p">,</span> <span class="c1"># Use validated final_status</span>
                <span class="n">artifacts</span><span class="o">=</span><span class="n">written_files</span><span class="p">,</span> <span class="c1"># Pass list of successfully written files</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status_updated</span><span class="p">:</span> <span class="n">status_update_error</span> <span class="o">=</span> <span class="s2">&quot;StateManager reported status update failed.&quot;</span><span class="p">;</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">status_update_error</span><span class="p">)</span>

        <span class="c1"># &lt;&lt;&lt; Catch StateManager init errors specifically &gt;&gt;&gt;</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
             <span class="n">status_update_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state for status update: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">status_update_error</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during status update for stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="n">status_update_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error during status update: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="n">status_update_error</span> <span class="o">=</span> <span class="s2">&quot;Status update skipped due to artifact writing errors.&quot;</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">status_update_error</span><span class="p">)</span>
    <span class="c1"># --- End Status Update --- #</span>

    <span class="c1"># --- Construct Response --- #</span>
    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Errors occurred during artifact writing.&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span> <span class="s2">&quot;written_files&quot;</span><span class="p">:</span> <span class="n">written_files</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">status_update_error</span><span class="p">:</span>
         <span class="c1"># Artifacts might have been written even if status update failed</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Artifacts partially/fully written, but status update failed: </span><span class="si">{</span><span class="n">status_update_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;written_files&quot;</span><span class="p">:</span> <span class="n">written_files</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">status_updated</span><span class="p">:</span>
         <span class="c1"># Should ideally be covered by status_update_error, but as a fallback</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Artifacts written, but status update failed for an unknown reason.&quot;</span><span class="p">,</span> <span class="s2">&quot;written_files&quot;</span><span class="p">:</span> <span class="n">written_files</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Stage </span><span class="si">{</span><span class="n">stage_number</span><span class="si">}</span><span class="s2"> artifacts submitted and status updated to </span><span class="si">{</span><span class="n">final_status</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="s2">&quot;written_files&quot;</span><span class="p">:</span> <span class="n">written_files</span><span class="p">,</span> <span class="s2">&quot;next_action_hint&quot;</span><span class="p">:</span> <span class="s2">&quot;execute_next_stage&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_load_reflections">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_load_reflections">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;load_reflections&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Loads past reflections. Uses environment variable for project dir if target_directory not provided.&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_load_reflections</span><span class="p">(</span><span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;load_reflections&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;load_reflections&#39; request (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;) with args: </span><span class="si">{</span><span class="n">ctx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory. Provide valid &#39;target_directory&#39; argument or set CHUNGOID_PROJECT_DIR env var and restart server.&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading reflections for effective target: &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># &lt;&lt;&lt; Initialize StateManager within the handler &gt;&gt;&gt;</span>
        <span class="n">context_state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

        <span class="n">reflections</span> <span class="o">=</span> <span class="n">context_state_manager</span><span class="o">.</span><span class="n">get_recent_reflections</span><span class="p">()</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">reflections</span><span class="p">:</span>
             <span class="c1"># ... (Keep reflection summarization logic) ...</span>
             <span class="n">num_to_summarize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>
             <span class="n">summary_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Summary of last </span><span class="si">{</span><span class="n">num_to_summarize</span><span class="si">}</span><span class="s2"> reflections:&quot;</span><span class="p">]</span>
             <span class="k">for</span> <span class="n">reflection</span> <span class="ow">in</span> <span class="n">reflections</span><span class="p">:</span>
                <span class="n">stage</span> <span class="o">=</span> <span class="n">reflection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stage_completed&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Stage&#39;</span><span class="p">)</span>
                <span class="n">challenges</span> <span class="o">=</span> <span class="n">reflection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encountered_challenges&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="n">reflection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;improvement_suggestions&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  - Stage </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">:&quot;</span>
                <span class="k">if</span> <span class="n">challenges</span><span class="p">:</span> <span class="n">part</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Challenges: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">challenges</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span> <span class="n">part</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Suggestions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">challenges</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suggestions</span><span class="p">:</span> <span class="n">part</span> <span class="o">+=</span> <span class="s2">&quot; No specific challenges or suggestions noted.&quot;</span>
                <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
             <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_parts</span><span class="p">)</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded and summarized </span><span class="si">{</span><span class="n">num_to_summarize</span><span class="si">}</span><span class="s2"> reflections via StateManager.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;No recent reflections found.&quot;</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No recent reflections found via StateManager.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">}</span>

    <span class="c1"># &lt;&lt;&lt; Catch StateManager init errors specifically &gt;&gt;&gt;</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed loading reflections for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state to load reflections: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading reflections via StateManager for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while loading reflections: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_get_file">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_get_file">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_file&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Reads the content of a specific file within the project directory. Path must be relative to the project root.&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_get_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;get_file&#39; tool. Reads a file after security checks.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;get_file&#39; request for path: &#39;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="s2">&#39; (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory.&quot;</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">relative_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid &#39;relative_path&#39;. Must be a non-empty string.&quot;</span><span class="p">}</span>

    <span class="c1"># Security: Basic check for path traversal attempts in the input string itself</span>
    <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Security risk: Path traversal detected in relative path argument: &#39;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">target_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>
        <span class="c1"># Resolve the absolute path</span>
        <span class="n">absolute_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dir_path</span> <span class="o">/</span> <span class="n">relative_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="c1"># --- CRUCIAL SECURITY CHECK ---</span>
        <span class="c1"># Ensure the resolved path is strictly within the target project directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">absolute_path</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="n">target_dir_path</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Security risk: Resolved path &#39;</span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2">&#39; is outside target project directory &#39;</span><span class="si">{</span><span class="n">target_dir_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># Optionally raise SecurityError(msg) or return error dict</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Access denied: Path is outside the project boundary.&quot;</span><span class="p">}</span>
        <span class="c1"># --- END SECURITY CHECK ---</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">absolute_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File not found or is not a file at resolved path: </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to read file: </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Read file content</span>
        <span class="c1"># Handle potential encoding issues if necessary, but start with default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully read file: </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="c1"># Return the requested relative path</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">ude</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoding error reading file </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ude</span><span class="si">}</span><span class="s2">. Trying &#39;latin-1&#39;.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully read file with latin-1: </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                    <span class="s2">&quot;encoding_note&quot;</span><span class="p">:</span> <span class="s2">&quot;File read using latin-1 encoding due to UTF-8 error.&quot;</span>
                 <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_fallback</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read file </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2"> even with latin-1 fallback: </span><span class="si">{</span><span class="n">e_fallback</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to read file &#39;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="s2">&#39; due to encoding or other read error.&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read file </span><span class="si">{</span><span class="n">absolute_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to read file &#39;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span> <span class="c1"># Catch potential errors from Path construction if input is weird</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid path specified: </span><span class="si">{</span><span class="n">ve</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid path specified: </span><span class="si">{</span><span class="n">ve</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in handle_get_file for path &#39;</span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected server error occurred processing get_file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_get_reflections_tool">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_get_reflections_tool">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_reflections&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Retrieves relevant reflections from the project&#39;s history using semantic search and optional filters.&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_get_reflections_tool</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">n_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">filter_stage_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;get_reflections&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received &#39;get_reflections&#39; request with query: &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;, n_results: </span><span class="si">{</span><span class="n">n_results</span><span class="si">}</span><span class="s2">, filter_stage_min: </span><span class="si">{</span><span class="n">filter_stage_min</span><span class="si">}</span><span class="s2"> (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory.&quot;</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid &#39;query&#39;. Must be a non-empty string.&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n_results</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">n_results</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># Default to 3 if invalid</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid n_results received, defaulting to </span><span class="si">{</span><span class="n">n_results</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

        <span class="n">stage_number_filter</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Define variable for stage number</span>
        <span class="k">if</span> <span class="n">filter_stage_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_stage_min</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># &lt;&lt;&lt; Check if string</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stage_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filter_stage_min</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Convert string to float</span>
                <span class="n">stage_number_filter</span> <span class="o">=</span> <span class="n">stage_min</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying stage number filter: </span><span class="si">{</span><span class="n">stage_number_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid filter_stage_min value &#39;</span><span class="si">{</span><span class="n">filter_stage_min</span><span class="si">}</span><span class="s2">&#39;, cannot convert to float. Ignoring filter. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filter_stage_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Log if not None but also not a string</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received filter_stage_min but it was not a string (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">filter_stage_min</span><span class="p">)</span><span class="si">}</span><span class="s2">). Ignoring filter.&quot;</span><span class="p">)</span>

        <span class="n">reflections</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state_manager</span><span class="o">.</span><span class="n">get_reflections</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">n_results</span><span class="o">=</span><span class="n">n_results</span><span class="p">,</span>
            <span class="n">stage_number</span><span class="o">=</span><span class="n">stage_number_filter</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span><span class="si">}</span><span class="s2"> reflections.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reflections&quot;</span><span class="p">:</span> <span class="n">reflections</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed loading reflections for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state to load reflections: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error retrieving reflections for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected server error occurred while retrieving reflections: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_find_artifacts">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_find_artifacts">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;find_artifacts&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;Searches for relevant project artifacts (like code files, documents, reports) using semantic search &quot;</span>
        <span class="s2">&quot;and optional filters (type, stage). Returns a list of matching artifacts with metadata and snippets.&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_find_artifacts</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">artifact_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Optional filter by type (e.g., &#39;code&#39;, &#39;design&#39;, &#39;report&#39;)</span>
    <span class="n">stage_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Optional filter by stage number</span>
    <span class="n">n_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;find_artifacts&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Received &#39;find_artifacts&#39; request with query: &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;, type: </span><span class="si">{</span><span class="n">artifact_type</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;stage: </span><span class="si">{</span><span class="n">stage_filter</span><span class="si">}</span><span class="s2">, n_results: </span><span class="si">{</span><span class="n">n_results</span><span class="si">}</span><span class="s2"> (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory.&quot;</span><span class="p">}</span>

    <span class="c1"># --- Input Validation ---</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid &#39;query&#39;. Must be a non-empty string.&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n_results</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_results</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Default to 5 if invalid</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid n_results received, defaulting to </span><span class="si">{</span><span class="n">n_results</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># --- End Validation ---</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>

        <span class="n">where_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;artifact&quot;</span><span class="p">}</span> <span class="c1"># Base filter</span>
        <span class="k">if</span> <span class="n">artifact_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artifact_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                 <span class="n">where_filter</span><span class="p">[</span><span class="s2">&quot;artifact_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">artifact_type</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding artifact_type filter: </span><span class="si">{</span><span class="n">artifact_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid artifact_type &#39;</span><span class="si">{</span><span class="n">artifact_type</span><span class="si">}</span><span class="s2">&#39;, ignoring filter.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># &lt;&lt;&lt; Check if string</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stage_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Convert string to float</span>
                <span class="n">where_filter</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage_num</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding stage filter: </span><span class="si">{</span><span class="n">stage_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid stage_filter value &#39;</span><span class="si">{</span><span class="n">stage_filter</span><span class="si">}</span><span class="s2">&#39;, cannot convert to float. Ignoring filter. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stage_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Log if not None but also not a string</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received stage_filter but it was not a string (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">)</span><span class="si">}</span><span class="s2">). Ignoring filter.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constructed where filter for artifact search: </span><span class="si">{</span><span class="n">where_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Call the synchronous StateManager method WITHOUT await</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="n">state_manager</span><span class="o">.</span><span class="n">get_artifact_context_from_chroma</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">n_results</span><span class="o">=</span><span class="n">n_results</span><span class="p">,</span>
            <span class="n">where_filter</span><span class="o">=</span><span class="n">where_filter</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">artifacts</span><span class="p">)</span><span class="si">}</span><span class="s2"> artifacts matching the query and filters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;found_artifacts&quot;</span><span class="p">:</span> <span class="n">artifacts</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed finding artifacts for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state to find artifacts: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error finding artifacts for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected server error occurred while finding artifacts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_list_artifacts">
<a class="viewcode-back" href="../index.html#chungoidmcp.handle_list_artifacts">[docs]</a>
<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;list_artifacts&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;Lists artifacts based on metadata filters (stage, type). Does NOT perform semantic search. &quot;</span>
        <span class="s2">&quot;Use this to discover available artifacts before using &#39;find_artifacts&#39; for content search.&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_list_artifacts</span><span class="p">(</span>
    <span class="n">stage_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>      <span class="c1"># Optional filter by stage number (as string)</span>
    <span class="n">artifact_type_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Optional filter by type (e.g., &#39;code&#39;, &#39;design&#39;)</span>
    <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>            <span class="c1"># Optional limit on number of results</span>
    <span class="n">target_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for the &#39;list_artifacts&#39; tool.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Received &#39;list_artifacts&#39; request with stage: </span><span class="si">{</span><span class="n">stage_filter</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="n">artifact_type_filter</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;limit: </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> (explicit target: &#39;</span><span class="si">{</span><span class="n">target_directory</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">effective_target_directory</span> <span class="o">=</span> <span class="n">_get_target_directory</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_target_directory</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not determine project directory.&quot;</span><span class="p">}</span>

    <span class="c1"># --- Input Validation/Conversion --- # </span>
    <span class="n">stage_num_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">stage_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stage_num_filter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted stage_filter &#39;</span><span class="si">{</span><span class="n">stage_filter</span><span class="si">}</span><span class="s2">&#39; to float: </span><span class="si">{</span><span class="n">stage_num_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid stage_filter value &#39;</span><span class="si">{</span><span class="n">stage_filter</span><span class="si">}</span><span class="s2">&#39;, cannot convert to float. Ignoring filter.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stage_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received stage_filter but it was not a string (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stage_filter</span><span class="p">)</span><span class="si">}</span><span class="s2">). Ignoring filter.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid limit &#39;</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&#39;, ignoring limit.&quot;</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- End Validation --- #</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">state_manager</span> <span class="o">=</span> <span class="n">_initialize_state_manager_for_target</span><span class="p">(</span><span class="n">effective_target_directory</span><span class="p">)</span>
        
        <span class="n">artifact_metadata_list</span> <span class="o">=</span> <span class="n">state_manager</span><span class="o">.</span><span class="n">list_artifact_metadata</span><span class="p">(</span>
            <span class="n">stage_filter</span><span class="o">=</span><span class="n">stage_num_filter</span><span class="p">,</span>
            <span class="n">artifact_type_filter</span><span class="o">=</span><span class="n">artifact_type_filter</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">artifact_metadata_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> artifact metadata entries matching the filters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;found_artifact_metadata&quot;</span><span class="p">:</span> <span class="n">artifact_metadata_list</span> <span class="c1"># Return the list of metadata dicts</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">StatusFileError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">sm_init_error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StateManager initialization failed listing artifacts for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to initialize project state to list artifacts: </span><span class="si">{</span><span class="n">sm_init_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error listing artifacts for target &#39;</span><span class="si">{</span><span class="n">effective_target_directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected server error occurred while listing artifacts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<span class="c1"># --- Main Execution Block ---</span>

<span class="c1"># Run the MCP server using the stdio transport</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Chungoid MCP Server via STDIO...&quot;</span><span class="p">)</span>
    <span class="n">mcp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="s2">&quot;stdio&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chungoid MCP Server finished.&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, AI Assistant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>